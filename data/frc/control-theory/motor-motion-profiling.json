{
  "title": "Motion Profiling",
  "sections": [
    {
      "type": "text",
      "title": "Overview",
      "content": "PID control alone can be jerky. <strong>Motion Profiling</strong> plans a smooth path (trajectory) from start to finish, defining velocity and acceleration at every point. This reduces mechanical stress and improves accuracy."
    },
    {
      "type": "text",
      "title": "Profile Types",
      "content": "<strong>Trapezoidal:</strong> Constant acceleration → Max velocity (cruise) → Constant deceleration. Fast and predictable.<br><strong>Exponential:</strong> Smooth, continuous acceleration changes. Natural feeling, great for elevators/arms."
    },
    {
      "type": "rules-box",
      "title": "Hardware Support",
      "subtitle": "Built-in controller features:",
      "items": [
        "<strong>REV (SPARK MAX):</strong> Uses <code>MAXMotion</code> (Trapezoidal).",
        "<strong>CTRE (Talon FX):</strong> Uses <code>Motion Magic</code> (Trapezoidal/S-Curve) and <code>Motion Magic Expo</code> (Exponential)."
      ]
    },
    {
      "type": "text",
      "title": "Configuration",
      "content": "Key constraints:<br><strong>Max Velocity:</strong> Top speed limit.<br><strong>Max Acceleration:</strong> How fast to speed up/slow down.<br><strong>Jerk (Optional):</strong> Rate of acceleration change (smoothing)."
    },
    {
      "type": "code-tabs",
      "title": "Trapezoidal Setup",
      "content": "Configuring Trapezoidal profiles:",
      "tabs": [
        {
          "label": "SPARK MAX (MAXMotion)",
          "code": "package frc.robot.subsystems;\n\nimport com.revrobotics.spark.SparkMax;\nimport com.revrobotics.spark.SparkLowLevel.MotorType;\nimport com.revrobotics.spark.config.SparkMaxConfig;\nimport com.revrobotics.spark.ClosedLoopController.ControlType;\nimport com.revrobotics.spark.ClosedLoopController.ClosedLoopSlot;\nimport com.revrobotics.spark.SparkBase.ResetMode;\nimport com.revrobotics.spark.SparkBase.PersistMode;\n\npublic class Elevator extends SubsystemBase {\n    private SparkMax motor = new SparkMax(1, MotorType.kBrushless);\n    private SparkClosedLoopController controller = motor.getClosedLoopController();\n    \n    // ... (other fields and methods)\n    \n    public void configureMotionProfile() {\n        SparkMaxConfig config = new SparkMaxConfig();\n        // Configure motion profile constraints for Slot 0\n        config.closedLoop.maxMotion\n            .maxVelocity(3000, ClosedLoopSlot.kSlot0)  // Max velocity in RPM\n            .maxAcceleration(2000, ClosedLoopSlot.kSlot0); // Max acceleration in RPM/s\n        motor.configure(config, ResetMode.kResetSafeParameters, PersistMode.kPersistParameters);\n    }\n    \n    public void setPosition(double target) {\n        // Use MAXMotion position control (trapezoidal profile)\n        controller.setReference(target, ControlType.kMAXMotionPositionControl);\n    }\n    \n    // ... (rest of class)"
        },
        {
          "label": "Talon FX (Motion Magic)",
          "code": "package frc.robot.subsystems;\n\nimport com.ctre.phoenix6.configs.MotionMagicConfigs;\nimport com.ctre.phoenix6.controls.MotionMagicVoltage;\nimport com.ctre.phoenix6.hardware.TalonFX;\n\npublic class Elevator extends SubsystemBase {\n    private TalonFX motor = new TalonFX(1);\n    \n    // ... (other fields and methods)\n    \n    public void configureMotionProfile() {\n        // Configure Motion Magic (trapezoidal profile)\n        MotionMagicConfigs mm = new MotionMagicConfigs();\n        mm.MotionMagicCruiseVelocity = 10;  // Max velocity in rotations/sec\n        mm.MotionMagicAcceleration = 20;    // Max acceleration in rotations/sec²\n        mm.MotionMagicJerk = 100;           // Jerk limit for smoothing\n        motor.getConfigurator().apply(mm);\n    }\n    \n    public void setPosition(double target) {\n        // Use Motion Magic position control\n        motor.setControl(new MotionMagicVoltage(target));\n    }\n    \n    // ... (rest of class)"
        }
      ]
    },
    {
      "type": "code-tabs",
      "title": "Exponential Setup",
      "content": "Configuring Exponential profiles:",
      "tabs": [
        {
          "label": "SPARK MAX (WPILib)",
          "code": "package frc.robot.subsystems;\n\nimport edu.wpi.first.math.trajectory.ExponentialProfile;\nimport com.revrobotics.spark.ClosedLoopController.ControlType;\n\npublic class Elevator extends SubsystemBase {\n    // Define profile constraints from system characteristics\n    private static final double kMaxV = 10.0; // Max velocity\n    private static final double kV = 0.12;    // Velocity feedforward\n    private static final double kA = 0.01;    // Acceleration feedforward\n    \n    private ExponentialProfile.Constraints constraints = \n        ExponentialProfile.Constraints.fromCharacteristics(kMaxV, kV, kA);\n    private ExponentialProfile profile = new ExponentialProfile(constraints);\n    \n    // ... (other fields and methods)\n    \n    @Override\n    public void periodic() {\n        // Calculate next setpoint from profile\n        double dt = 0.02; // 20ms loop time\n        double current = getCurrentPosition();\n        double goal = getTargetPosition();\n        \n        var state = profile.calculate(dt, current, goal);\n        // Apply position setpoint to PID controller\n        pid.setReference(state.position, ControlType.kPosition);\n    }\n    \n    // ... (rest of class)"
        },
        {
          "label": "Talon FX (MM Expo)",
          "code": "package frc.robot.subsystems;\n\nimport com.ctre.phoenix6.configs.MotionMagicConfigs;\nimport com.ctre.phoenix6.controls.MotionMagicExpoVoltage;\nimport com.ctre.phoenix6.hardware.TalonFX;\n\npublic class Elevator extends SubsystemBase {\n    private TalonFX motor = new TalonFX(1);\n    \n    // ... (other fields and methods)\n    \n    public void configureExponentialProfile() {\n        // Configure Motion Magic Exponential profile\n        MotionMagicConfigs mm = new MotionMagicConfigs();\n        mm.MotionMagicExpo_kV = 0.12; // Velocity feedforward\n        mm.MotionMagicExpo_kA = 0.01; // Acceleration feedforward\n        motor.getConfigurator().apply(mm);\n    }\n    \n    public void setPosition(double target) {\n        // Use exponential motion profile\n        motor.setControl(new MotionMagicExpoVoltage(target));\n    }\n    \n    // ... (rest of class)"
        }
      ]
    },
    {
      "type": "text",
      "title": "Tuning Exponential Profiles",
      "content": "Tune feedforward first (kG, kV, kA), then feedback (kP, kD). Use simulation and dashboard tools like Elastic for live tuning. Log position and velocity graphs to observe behavior."
    },
    {
      "type": "rules-box",
      "title": "Feedforward Tuning",
      "subtitle": "Physical forces:",
      "items": [
        "<strong>kG (Gravity):</strong> Set setpoint high, increase kG from 0. Find value where mechanism just starts to creep upward, then back off slightly.",
        "<strong>kV (Velocity):</strong> Run at fixed duty cycle, observe voltage and max velocity. kV = Voltage / Max Velocity (RPS). Use first 4-5 decimal places.",
        "<strong>kA (Acceleration):</strong> Trigger movement, measure time from 0 to max velocity. kA = kV / Time to Max Velocity."
      ]
    },
    {
      "type": "rules-box",
      "title": "Feedback Tuning",
      "subtitle": "Position correction:",
      "items": [
        "<strong>kP (Proportional):</strong> Start small (0.1). Double values until mechanism moves. Too low = slow/sluggish curve. Too high = overshoot/oscillation. Ideal = straight line to setpoint.",
        "<strong>kD (Derivative):</strong> Start tiny (0.005-0.05). Increase to dampen oscillations. Too high = high-frequency jitter/noise causing motor heating. Goal = smooth flat line."
      ]
    },
    {
      "type": "text",
      "title": "Tuning Goals",
      "content": "Position graph should look like a square wave: sharp rise, flat top, sharp drop without wobbling at corners. Ensure no oscillation causing mechanism to slam into limits. Simulation provides baseline values; physical robots may need slight adjustments for friction and gravity."
    },
    {
      "type": "link-grid",
      "title": "Related",
      "links": [
        {
          "label": "PID Control",
          "id": "pid-control"
        },
        {
          "label": "CTRE Motion Magic",
          "url": "https://v6.docs.ctr-electronics.com/en/latest/docs/api-reference/device-specific/talonfx/motion-magic.html"
        }
      ]
    }
  ]
}
